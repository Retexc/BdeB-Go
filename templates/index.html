<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BdeB-GTFS</title>
  <link rel="stylesheet" href="./static/index.css" />
  <script>

  document.addEventListener('DOMContentLoaded', () => {
    const preloader = document.querySelector('.preloader');
    const mainContent = document.querySelector('.main-container');

    // Option A: Hide main content until loader finishes
    mainContent.style.display = 'none';

    // Option B: Listen for the animation end, then hide the preloader
    const bWrapper = document.querySelector('.b-wrapper');
    bWrapper.addEventListener('animationend', () => {
      // Fade out the entire overlay
      preloader.classList.add('fade-out');
    });

    // Once the overlay is faded out, remove it from the DOM and show main content
    preloader.addEventListener('transitionend', () => {
      preloader.style.display = 'none';
      mainContent.style.display = 'block';
    });
  });    
    async function refreshData() {
      try {
        const response = await fetch('/api/data'); // Call the API endpoint
        const data = await response.json();

        // Update current time
        const timeElement = document.querySelector('.time');
        const currentTimeParts = data.current_time.split(':');
        timeElement.textContent = `${currentTimeParts[0]}:${currentTimeParts[1]} ${currentTimeParts[2].split(' ')[1]}`;

        // ===================
        //  STM BUSES
        // ===================
        const frameContainer = document.querySelector('.frame');
        frameContainer.innerHTML = ''; // Clear old content

        // STM Logo
        const stmLogoDiv = document.createElement('div');
        stmLogoDiv.className = "stm-logo-container";
        stmLogoDiv.innerHTML = `<img src="/static/assets/images/STM.png" alt="STM logo" class="stm-logo">`;
        frameContainer.appendChild(stmLogoDiv);

        // Render each bus row
        data.buses.forEach((bus) => {
          const busDiv = document.createElement('div');
          // Apply "frame-1" for each row; also handle canceled
          busDiv.className = `frame-1 ${bus.arrival_time === 'Indisponible (Route annulée)' ? 'canceled' : ''}`;

          // Build occupancy icons
          let occupancyIcons = '';
          if (bus.occupancy === "MANY_SEATS_AVAILABLE") {
            occupancyIcons = `
              <img src="/static/assets/icons/green-person.png" alt="Light occupancy" class="occupancy-icon">
              <img src="/static/assets/icons/gray-person.png" alt="" class="occupancy-icon">
              <img src="/static/assets/icons/gray-person.png" alt="" class="occupancy-icon">
              <img src="/static/assets/icons/gray-person.png" alt="" class="occupancy-icon">
            `;
          } else if (bus.occupancy === "FEW_SEATS_AVAILABLE") {
            occupancyIcons = `
              <img src="/static/assets/icons/green-person.png" alt="Light occupancy" class="occupancy-icon">
              <img src="/static/assets/icons/green-person.png" alt="Light occupancy" class="occupancy-icon">
              <img src="/static/assets/icons/gray-person.png" alt="" class="occupancy-icon">
              <img src="/static/assets/icons/gray-person.png" alt="" class="occupancy-icon">
            `;
          } else if (bus.occupancy === "STANDING_ROOM_ONLY") {
            occupancyIcons = `
              <img src="/static/assets/icons/yellow-person.png" alt="Medium occupancy" class="occupancy-icon">
              <img src="/static/assets/icons/yellow-person.png" alt="" class="occupancy-icon">
              <img src="/static/assets/icons/yellow-person.png" alt="" class="occupancy-icon">
              <img src="/static/assets/icons/gray-person.png" alt="" class="occupancy-icon">
            `;
          } else if (bus.occupancy === "FULL") {
            occupancyIcons = `
              <img src="/static/assets/icons/red-person.png" alt="Full occupancy" class="occupancy-icon">
              <img src="/static/assets/icons/red-person.png" alt="" class="occupancy-icon">
              <img src="/static/assets/icons/red-person.png" alt="" class="occupancy-icon">
              <img src="/static/assets/icons/red-person.png" alt="" class="occupancy-icon">
            `;
          } else {
            // Unknown
            occupancyIcons = `
              <img src="/static/assets/icons/invisible-person.png" class="occupancy-icon">
              <img src="/static/assets/icons/invisible-person.png" class="occupancy-icon">
              <img src="/static/assets/icons/invisible-person.png" class="occupancy-icon">
              <img src="/static/assets/icons/invisible-person.png" class="occupancy-icon">
            `;
          }

          // Build final icons row
          let iconsHTML = occupancyIcons;
          if (bus.wheelchair_accessible) {
            iconsHTML += `<img src="/static/assets/icons/wheelchair.png" class="wheelchair" alt="Wheelchair Accessible">`;
          }
          if (bus.at_stop) {
            iconsHTML += `<img src="/static/assets/icons/bus.png" class="blinking-bus" alt="Bus at stop">`;
          }

          // Delay text
          const delayedText = bus.delayed_text ? 
            `<span class="delayed-text">${bus.delayed_text}</span>` : '';

          // Early text
          const earlyText = bus.early_text ? 
            `<span class="early-text">${bus.early_text}</span>` : '';

          // Time (or "Annulé")
          let timeStr = '';
          if (bus.arrival_time === 'Indisponible (Route annulée)') {
            timeStr = 'Annulé';
          } else {
            timeStr = `${bus.arrival_time} min`;
          }

          busDiv.innerHTML = `
            <!-- Column 1: Route Button -->
            <div class="bus-col-route">
              <div class="buttonBlueBuses">
                <span class="frame-2">${bus.route_id}</span>
              </div>
            </div>

            <!-- Column 2: Direction + Location -->
            <div class="bus-col-info">
              <span class="direction">
                <img src="/static/assets/icons/arrow_circle_white.png" alt="Direction Icon" class="direction-icon">
                ${bus.direction}
              </span>
              <span class="location">${bus.location}</span>
            </div>

            <!-- Column 3: Status line (delay text, time, icons) -->
            <div class="bus-col-status">
            <div class="status-line">
                <!-- 1) Delayed/Early Text Cell -->
                <div class="delay-cell">
                ${delayedText}${earlyText}
                </div>

                <!-- 2) Time Cell -->
                <div class="time-cell">
                <span class="time-remaining">${timeStr}</span>
                <img src="/static/assets/icons/signal.png" alt="Signal" class="blinking-signal" />
                </div>

                <!-- 3) Occupancy Cell (always 4 icons or placeholders) -->
                <div class="occupancy-cell">
                ${occupancyIcons}
                </div>

                <!-- 4) Wheelchair Cell (real icon or invisible placeholder) -->
                <div class="wheelchair-cell">
                ${
                    bus.wheelchair_accessible
                    ? `<img src="/static/assets/icons/wheelchair.png" class="wheelchair" alt="Wheelchair Accessible">`
                    : `<img src="/static/assets/icons/invisible.png" class="wheelchair" alt="">`
                }
                </div>

                <!-- 5) Bus Cell (real icon or invisible placeholder) -->
                <div class="bus-cell">
                ${
                    bus.at_stop
                    ? `<img src="/static/assets/icons/bus.png" class="blinking-bus" alt="Bus at stop">`
                    : `<img src="/static/assets/icons/invisible.png" class="blinking-bus" alt="">`
                }
                </div>
            </div>
            </div>
          `;
          frameContainer.appendChild(busDiv);
        });

        // ===================
        //  EXO TRAINS
        // ===================
        const trainContainer = document.querySelector('.train-frame');
        trainContainer.innerHTML = ''; // Clear old content

        const exoLogoDiv = document.createElement('div');
        exoLogoDiv.className = "exo-logo-container";
        exoLogoDiv.innerHTML = `<img src="/static/assets/images/exo_white.png" alt="Exo logo" class="exo-logo">`;
        trainContainer.appendChild(exoLogoDiv);

        data.next_trains.forEach((train) => {
          const trainDiv = document.createElement('div');
          trainDiv.className = "frame-1";

          // Occupancy icons (similar approach as above) ...
          // For brevity, do a shorter version:
          let occupancyIcons = '';
          if (train.occupancy === "Near_Empty") {
            occupancyIcons = `<img src="/static/assets/icons/green-person.png" class="occupancy-icon"> ...`;
            // etc.
          }

          let delayedText = train.delayed_text ? 
            `<span class="delayed-text">${train.delayed_text}</span>` : '';
          let earlyText = train.early_text ?
            `<span class="early-text">${train.early_text}</span>` : '';
          let timeStr = train.arrival_time || "Unknown";

          // Possibly show train blinking icon if at_stop
          let iconHTML = occupancyIcons;
          if (train.at_stop) {
            iconHTML += `<img src="/static/assets/icons/train.png" class="blinking-train">`;
          }

          trainDiv.innerHTML = `
            <!-- Column 1: Route button (ex: 12, 15, etc.) -->
            <div class="bus-col-route">
              <div class="${train.route_id === '12' ? 'buttonSJ' : 
                          train.route_id === '15' ? 'buttonMA' : 'defaultButton'}">
                <span class="frame-2-black">${train.route_id}</span>
              </div>
            </div>

            <!-- Column 2: direction + location -->
            <div class="bus-col-info">
              <span class="direction">
                <img src="/static/assets/icons/arrow_circle_white.png" alt="Direction Icon" class="direction-icon">
                ${train.direction || "Unknown"}
              </span>
              <span class="location">${train.location || "Unknown"}</span>
            </div>

            <!-- Column 3: status line -->
            <div class="bus-col-status">
              <div class="status-line">
                ${delayedText}
                ${earlyText}
                ${
                  train.no_service_text 
                  ? `<span class="no-service-text">${train.no_service_text}</span>` 
                  : `<span class="time-remaining">${timeStr}</span>`
                }
                ${iconHTML}
              </div>
            </div>
          `;
          trainContainer.appendChild(trainDiv);
        });

        updateAlerts(data);
      } catch (error) {
        console.error('Error fetching data:', error);
      }
    }

    function updateAlerts(data) {
      const alertContainer = document.getElementById('alertContainer');
      const alertText = document.querySelector('.alert-text');
      const marquee = document.querySelector('.alert-marquee');

      if (data.alerts && data.alerts.length > 0) {
        alertContainer.style.display = 'block';

        // Combine all alerts into a single scrolling text
        const allAlerts = data.alerts.map(a => {
          // Check if this is your custom alert
          if (a.routes === "Custom" && a.stop === "Message") {
            return `${a.header}: ${a.description}`;
          }
          else if (a.routes) {
            // Normal STM
            return `Ligne(s) : ${a.routes} (${a.stop}): ${a.header} - ${a.description}`;
          } 
          else {
            // EXO
            return `Train ${a.train_route}: ${a.header} - ${a.description}`;
          }
        }).join(' ••• ');

        alertText.textContent = allAlerts;

        // Adjust marquee speed
        const baseSpeed = 20;
        const minSpeed = 15;
        const maxSpeed = 50;
        const textLength = allAlerts.length;
        const duration = Math.min(maxSpeed, Math.max(minSpeed, textLength / 8));
        marquee.style.animation = `marquee ${duration}s linear infinite`;
      } else {
        alertContainer.style.display = 'none';
      }
    }

    setInterval(refreshData, 30000); // Refresh every 30s
    document.addEventListener('DOMContentLoaded', refreshData);
  </script>
</head>

<body>
  <div class="main-container">
    <span class="time">{{ current_time }}</span>
    <div class="frame"><!-- STM buses go here --></div>
    <div class="train-frame"><!-- EXO trains go here -->
    </div>
    <div class="footer-text">
      Données fournies par la STM et Exo
    </div>
  </div>
  <div class="logo-container">
    <img src="/static/assets/images/B.png" alt="Transport Logos">
  </div>

  <div id="alertContainer" class="alert-banner" style="display: none;">
    <div class="alert-marquee">
      <img src="/static/assets/icons/warning.png" class="alert-icon" alt="Alert">
      <span class="alert-text"></span>
    </div>
  </div>
<!-- 1) LOADER OVERLAY -->
<div class="preloader">
    <!-- B Logo Wrapper -->
    <div class="b-wrapper">
      <!-- Your B SVG (white fill recommended so it “expands” in white) -->
      <svg xmlns="http://www.w3.org/2000/svg" width="162" height="187" viewBox="0 0 162 187" fill="white" class="b-logo">
        <!-- (Same structure as your snippet, but fill="white" so it covers the screen when scaled) -->
        <mask id="mask0_1790_213173" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="0" y="0" width="159" height="187">
          <mask id="mask1_1790_213173" style="mask-type:luminance" maskUnits="userSpaceOnUse" x="0" y="0" width="162" height="187">
            <path d="M161.108 0H0L0 186.673H161.108L161.108 0Z" fill="white"/>
          </mask>
          <g mask="url(#mask1_1790_213173)">
            <path d="M-1.85059 186.673L-1.85059 0H98.0804C135.347 0.0828362 149.814 21.3752 155.064 34.188C159.602 45.0734 160.162 57.2024 156.648 68.4588C153.48 78.2125 147.541 86.8391 139.55 93.2887C147.542 99.7382 153.481 108.365 156.648 118.12C160.146 129.342 159.619 141.429 155.16 152.308C149.897 165.073 135.431 186.494 98.1751 186.59L-1.85059 186.673Z" fill="white"/>
          </g>
        </mask>
        <g mask="url(#mask0_1790_213173)">
          <rect x="-2158.4" y="-1199.37" width="4480.15" height="2552.75" fill="white"/>
        </g>
      </svg>
    </div>
  </div>    
</body>
</html>
