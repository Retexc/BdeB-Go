<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transport Real-Time</title>
    <link rel="stylesheet" href="./static/index.css">
    <script>
        async function refreshData() {
            try {
                const response = await fetch('/api/data'); // Call the API endpoint
                const data = await response.json();

                // Update current time
                const timeElement = document.querySelector('.time');
                const currentTimeParts = data.current_time.split(':');
                timeElement.textContent = `${currentTimeParts[0]}:${currentTimeParts[1]} ${currentTimeParts[2].split(' ')[1]}`;

                // Update buses
                const frameContainer = document.querySelector('.frame');
                frameContainer.innerHTML = ''; // Clear old content

                data.buses.forEach((bus) => {
                    const busDiv = document.createElement('div');
                    busDiv.className = `frame-1 ${bus.arrival_time === 'Unavailable (Route Canceled)' ? 'canceled' : ''}`;

                    // Occupancy icons
                    let occupancyIcons;
                    if (bus.occupancy === "Near_Empty") {
                        occupancyIcons = `
                            <img src="/static/assets/icons/green-person.png" alt="Light occupancy" class="occupancy-icon">
                            <img src="/static/assets/icons/gray-person.png" alt="Gray person" class="occupancy-icon">
                            <img src="/static/assets/icons/gray-person.png" alt="Gray person" class="occupancy-icon">
                            <img src="/static/assets/icons/gray-person.png" alt="Gray person" class="occupancy-icon">
                        `;
                    } else if (bus.occupancy === "Light") {
                        occupancyIcons = `
                            <img src="/static/assets/icons/green-person.png" alt="Light occupancy" class="occupancy-icon">
                            <img src="/static/assets/icons/green-person.png" alt="Light occupancy" class="occupancy-icon">
                            <img src="/static/assets/icons/gray-person.png" alt="Gray person" class="occupancy-icon">
                            <img src="/static/assets/icons/gray-person.png" alt="Gray person" class="occupancy-icon">
                        `;
                    } else if (bus.occupancy === "Medium") {
                        occupancyIcons = `
                            <img src="/static/assets/icons/yellow-person.png" alt="Medium occupancy" class="occupancy-icon">
                            <img src="/static/assets/icons/yellow-person.png" alt="Medium occupancy" class="occupancy-icon">
                            <img src="/static/assets/icons/yellow-person.png" alt="Medium occupancy" class="occupancy-icon">
                            <img src="/static/assets/icons/gray-person.png" alt="Gray person" class="occupancy-icon">
                        `;
                    } else if (bus.occupancy === "Full") {
                        occupancyIcons = `
                            <img src="/static/assets/icons/red-person.png" alt="Full occupancy" class="occupancy-icon">
                            <img src="/static/assets/icons/red-person.png" alt="Full occupancy" class="occupancy-icon">
                            <img src="/static/assets/icons/red-person.png" alt="Full occupancy" class="occupancy-icon">
                            <img src="/static/assets/icons/red-person.png" alt="Full occupancy" class="occupancy-icon">
                        `;                        
                    } else {
                        // Default to unknown occupancy (all gray)
                        occupancyIcons = `
                            <img src="/static/assets/icons/invisible-person.png" alt="Full occupancy" class="occupancy-icon">
                            <img src="/static/assets/icons/invisible-person.png" alt="Full occupancy" class="occupancy-icon">
                            <img src="/static/assets/icons/invisible-person.png" alt="Full occupancy" class="occupancy-icon">
                            <img src="/static/assets/icons/invisible-person.png" alt="Full occupancy" class="occupancy-icon">
                        `;
                    }

                    // Real-time signal
                    const signal = bus.arrival_time !== "Unavailable (Route Canceled)" ? '<img src="/static/assets/icons/signal.png" class="blinking-icon">' : '';

                    busDiv.innerHTML = `
                        <div class="buttonBlueBuses">
                            <span class="frame-2">${bus.route_id}</span>
                        </div>
                        <div class="frame-3">
                            <span class="direction">
                                <img src="/static/assets/icons/arrow_circle.png" alt="Direction Icon" class="direction-icon">
                                ${bus.direction}
                            </span>
                            <span class="location">${bus.location}</span>
                        </div>
                        <div class="frame-4">
                            <span class="time-remaining">${bus.arrival_time !== 'Unavailable (Route Canceled)' ? `${bus.arrival_time} min` : 'Annulé'}</span>
                            ${signal}
                            <div class="occupancy-group">
                                ${occupancyIcons}
                            </div>
                        </div>
                    `;
                    frameContainer.appendChild(busDiv);
                });
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        // Refresh data every 30 seconds
        setInterval(refreshData, 30000);
        document.addEventListener('DOMContentLoaded', refreshData);
    </script>
</head>
<body>
    <div class="main-container">
        <span class="time">{{ current_time }}</span>
        <div class="frame"></div>
        
        <!-- Static Train Section -->
        <div class="train-frame">
            <div class="frame-1">
                <div class="buttonSJ route-12">
                    <span class="frame-2">12</span>
                </div>
                <div class="frame-3">
                    <span class="direction">
                        <img src="/static/assets/icons/arrow_circle.png" alt="Direction Icon" class="direction-icon">
                        Lucien L'allier
                    </span>
                    <span class="location">Gare Bois-de-Boulogne</span>
                </div>
                <div class="frame-4">
                    <span class="time-remaining">0 min</span>
                    <div class="occupancy-group">
                        <img src="/static/assets/icons/red-person.png" alt="Full occupancy" class="occupancy-icon">
                        <img src="/static/assets/icons/red-person.png" alt="Full occupancy" class="occupancy-icon">
                        <img src="/static/assets/icons/red-person.png" alt="Full occupancy" class="occupancy-icon">
                    </div>
                </div>
            </div>
            <div class="frame-1">
                <div class="buttonSJ route-12">
                    <span class="frame-2">12</span>
                </div>
                <div class="frame-3">
                    <span class="direction">
                        <img src="/static/assets/icons/arrow_circle.png" alt="Direction Icon" class="direction-icon">
                        Saint-Jérôme
                    </span>
                    <span class="location">Gare Bois-de-Boulogne</span>
                </div>
                <div class="frame-4">
                    <span class="time-remaining">0 min</span>
                    <div class="occupancy-group">
                        <img src="/static/assets/icons/green-person.png" alt="Light occupancy" class="occupancy-icon">
                        <img src="/static/assets/icons/green-person.png" alt="Light occupancy" class="occupancy-icon">
                        <img src="/static/assets/icons/gray-person.png" alt="Gray person" class="occupancy-icon">
                    </div>
                </div>
            </div>
            <div class="frame-1">
                <div class="buttonMA route-15">
                    <span class="frame-2">15</span>
                </div>
                <div class="frame-3">
                    <span class="direction">
                        <img src="/static/assets/icons/arrow_circle.png" alt="Direction Icon" class="direction-icon">
                        Mascouche
                    </span>
                    <span class="location">Gare Ahuntsic</span>
                </div>
                <div class="frame-4">
                    <span class="time-remaining">0 min</span>
                    <div class="occupancy-group">
                        <img src="/static/assets/icons/yellow-person.png" alt="Medium occupancy" class="occupancy-icon">
                        <img src="/static/assets/icons/yellow-person.png" alt="Medium occupancy" class="occupancy-icon">
                        <img src="/static/assets/icons/gray-person.png" alt="Gray person" class="occupancy-icon">
                    </div>
                </div>
            </div>
        </div>

        <div class="footer-text">
            Données fournies par la STM et Exo
        </div>
    </div>
    <div class="logo-container">
        <img src="/static/assets/images/B.png" alt="Transport Logos">
    </div>
</body>
</html>
