<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transport Real-Time</title>
    <link rel="stylesheet" href="./static/index.css">
    <script>
        async function refreshData() {
            try {
                const response = await fetch('/api/data'); // Call the API endpoint
                const data = await response.json();

                // Update current time
                const timeElement = document.querySelector('.time');
                const currentTimeParts = data.current_time.split(':');
                timeElement.textContent = `${currentTimeParts[0]}:${currentTimeParts[1]} ${currentTimeParts[2].split(' ')[1]}`;

                // Update buses
                const frameContainer = document.querySelector('.frame');
                frameContainer.innerHTML = ''; // Clear old content

                data.buses.forEach((bus) => {
                    const busDiv = document.createElement('div');
                    busDiv.className = `frame-1 ${bus.arrival_time === 'Unavailable (Route Canceled)' ? 'canceled' : ''}`;

                    // Occupancy icons
                    let occupancyIcons;
                    if (bus.occupancy === "Near_Empty") {
                        occupancyIcons = `
                            <img src="/static/assets/icons/green-person.png" alt="Light occupancy" class="occupancy-icon">
                            <img src="/static/assets/icons/gray-person.png" alt="Gray person" class="occupancy-icon">
                            <img src="/static/assets/icons/gray-person.png" alt="Gray person" class="occupancy-icon">
                            <img src="/static/assets/icons/gray-person.png" alt="Gray person" class="occupancy-icon">
                        `;
                    } else if (bus.occupancy === "Light") {
                        occupancyIcons = `
                            <img src="/static/assets/icons/green-person.png" alt="Light occupancy" class="occupancy-icon">
                            <img src="/static/assets/icons/green-person.png" alt="Light occupancy" class="occupancy-icon">
                            <img src="/static/assets/icons/gray-person.png" alt="Gray person" class="occupancy-icon">
                            <img src="/static/assets/icons/gray-person.png" alt="Gray person" class="occupancy-icon">
                        `;
                    } else if (bus.occupancy === "Medium") {
                        occupancyIcons = `
                            <img src="/static/assets/icons/yellow-person.png" alt="Medium occupancy" class="occupancy-icon">
                            <img src="/static/assets/icons/yellow-person.png" alt="Medium occupancy" class="occupancy-icon">
                            <img src="/static/assets/icons/yellow-person.png" alt="Medium occupancy" class="occupancy-icon">
                            <img src="/static/assets/icons/gray-person.png" alt="Gray person" class="occupancy-icon">
                        `;
                    } else if (bus.occupancy === "Full") {
                        occupancyIcons = `
                            <img src="/static/assets/icons/red-person.png" alt="Full occupancy" class="occupancy-icon">
                            <img src="/static/assets/icons/red-person.png" alt="Full occupancy" class="occupancy-icon">
                            <img src="/static/assets/icons/red-person.png" alt="Full occupancy" class="occupancy-icon">
                            <img src="/static/assets/icons/red-person.png" alt="Full occupancy" class="occupancy-icon">
                        `;                        
                    } else {
                        // Default to unknown occupancy (all gray)
                        occupancyIcons = `
                            <img src="/static/assets/icons/invisible-person.png" alt="Full occupancy" class="occupancy-icon">
                            <img src="/static/assets/icons/invisible-person.png" alt="Full occupancy" class="occupancy-icon">
                            <img src="/static/assets/icons/invisible-person.png" alt="Full occupancy" class="occupancy-icon">
                            <img src="/static/assets/icons/invisible-person.png" alt="Full occupancy" class="occupancy-icon">
                        `;
                    }

                    // Real-time signal
                    const signal = bus.arrival_time !== "Unavailable (Route Canceled)" ? '<img src="/static/assets/icons/signal.png" class="blinking-icon">' : '';

                    busDiv.innerHTML = `
                        <div class="button">
                            <span class="frame-2">${bus.route_id}</span>
                        </div>
                        <div class="frame-3">
                            <span class="direction">
                                <img src="/static/assets/icons/arrow_circle.png" alt="Direction Icon" class="direction-icon">
                                ${bus.direction}
                            </span>
                            <span class="location">${bus.location}</span>
                        </div>

                        <div class="frame-4">
                            <span class="time-remaining">${bus.arrival_time !== 'Unavailable (Route Canceled)' ? `${bus.arrival_time} min` : 'Annulé'}</span>
                            ${signal}
                            <div class="occupancy-group">
                                ${occupancyIcons}
                            </div>
                        </div>
                    `;
                    frameContainer.appendChild(busDiv);
                });

                // Update trains
                const trainContainer = document.querySelector('.train-frame');
                trainContainer.innerHTML = '';

                data.next_trains.forEach((train) => {
                    const trainDiv = document.createElement('div');
                    trainDiv.className = 'frame-1';

                    // Occupancy icons logic for trains
                    let occupancyIcons;
                    if (train.occupancy === "Near_Empty") {
                        occupancyIcons = `
                            <img src="/static/assets/icons/green-person.png" alt="Light occupancy" class="occupancy-icon">
                            <img src="/static/assets/icons/gray-person.png" alt="Gray person" class="occupancy-icon">
                            <img src="/static/assets/icons/gray-person.png" alt="Gray person" class="occupancy-icon">
                            <img src="/static/assets/icons/gray-person.png" alt="Gray person" class="occupancy-icon">
                        `;
                    } else if (train.occupancy === "Light") {
                        occupancyIcons = `
                            <img src="/static/assets/icons/green-person.png" alt="Light occupancy" class="occupancy-icon">
                            <img src="/static/assets/icons/green-person.png" alt="Light occupancy" class="occupancy-icon">
                            <img src="/static/assets/icons/gray-person.png" alt="Gray person" class="occupancy-icon">
                            <img src="/static/assets/icons/gray-person.png" alt="Gray person" class="occupancy-icon">
                        `;
                    } else if (train.occupancy === "Medium") {
                        occupancyIcons = `
                            <img src="/static/assets/icons/yellow-person.png" alt="Medium occupancy" class="occupancy-icon">
                            <img src="/static/assets/icons/yellow-person.png" alt="Medium occupancy" class="occupancy-icon">
                            <img src="/static/assets/icons/yellow-person.png" alt="Medium occupancy" class="occupancy-icon">
                            <img src="/static/assets/icons/gray-person.png" alt="Gray person" class="occupancy-icon">
                        `;
                    } else if (train.occupancy === "Full") {
                        occupancyIcons = `
                            <img src="/static/assets/icons/red-person.png" alt="Full occupancy" class="occupancy-icon">
                            <img src="/static/assets/icons/red-person.png" alt="Full occupancy" class="occupancy-icon">
                            <img src="/static/assets/icons/red-person.png" alt="Full occupancy" class="occupancy-icon">
                            <img src="/static/assets/icons/red-person.png" alt="Full occupancy" class="occupancy-icon">
                        `;
                    } else {
                        // Default to unknown occupancy (all gray)
                        occupancyIcons = `
                            <img src="/static/assets/icons/invisible-person.png" alt="Unknown occupancy" class="occupancy-icon">
                            <img src="/static/assets/icons/invisible-person.png" alt="Unknown occupancy" class="occupancy-icon">
                            <img src="/static/assets/icons/invisible-person.png" alt="Unknown occupancy" class="occupancy-icon">
                            <img src="/static/assets/icons/invisible-person.png" alt="Unknown occupancy" class="occupancy-icon">
                        `;
                    }

                    // Real-time signal (optional)
                    const signal = '<img src="/static/assets/icons/signal.png" class="blinking-icon_train">';

                    trainDiv.innerHTML = `
                        <div class="button" style="background: ${train.route_id === '4' ? '#ebc977' : '#6e2379'}">
                            <span class="frame-2">${train.route_id}</span>
                        </div>
                        <div class="frame-3">
                            <span class="direction">${train.stop_id === 'MTL7B' ? 'Saint-Jérôme' : train.stop_id === 'MTL7D' ? 'Montreal-Ouest' : 'Mascouche'}</span>
                            <span class="location">${train.stop_id === 'MTL59A' ? 'Gare Ahuntsic' : 'Gare Bois-de-Boulogne'}</span>
                        </div>
                        <div class="frame-4">
                            <span class="time-remaining">${train.real_time || train.scheduled_time}</span>
                            ${signal}
                            <div class="occupancy-group">
                                ${occupancyIcons}
                            </div>
                        </div>
                    `;
                    trainContainer.appendChild(trainDiv);
                });

            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        // Refresh data every 30 seconds
        setInterval(refreshData, 30000);
        document.addEventListener('DOMContentLoaded', refreshData);
    </script>
</head>
<body>
    <div class="main-container">
        <span class="time">{{ current_time }}</span>
        <div class="frame"></div>
        <div class="train-frame"></div>
        <div class="footer-text">
            Données fournies par la STM et Exo
        </div>
        
    </div>
    <div class="logo-container">
        <img src="/static/assets/images/B.png" alt="Transport Logos">
    </div>
    
</body>
</html>
